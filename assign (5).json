{"paragraphs":[{"text":"%pyspark\r\nfrom pyspark import SparkContext\r\nfrom pyspark.sql import SQLContext\r\nfrom pyspark.sql.functions import to_timestamp\r\nfrom pyspark.sql.functions import *\r\nfrom pyspark.sql.window import Window\r\n\r\n#json.loads\r\npurchase = sqlContext.read.json(\"gs://de-training-input/alimazon/200000/client-orders/part_*.jsonl.gz\")\r\npurchase = purchase.withColumn(\"parsed1\", substring(\"timestamp\",0,10)).withColumn(\"parsed\", to_date(\"parsed1\", \"yyyy-MM-dd\")).withColumn(\"dayofWeek\", date_format(\"parsed\",\"u\"))\r\n#purchase.show()\r\n\r\ndfpur=purchase.groupBy(\"dayofWeek\",\"product_id\").agg({\"total\": 'sum','product_id':'count'}).withColumnRenamed('count(product_id)', 'orders_count').withColumnRenamed('sum(total)', 'gross-sales').cache()\r\n\r\ndef top10(df ,var, day):\r\n    dfn=dfpur.sort(var, ascending=False).drop(\"orders_count\",\"dayofWeek\").filter(dfpur.dayofWeek == day).limit(10)\r\n    dfn.show()\r\n    dfn.repartition(1).write.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").mode('overwrite').csv(\"gs://de-training-output-topifloresl/assignment-c3/top10-products-by-gross-spending-\"+str(day)+\".csv\")\r\n    return dfn\r\n\r\ncount_order1=top10(purchase,\"gross-sales\", 1)\r\ncount_order1=top10(purchase,\"gross-sales\", 2)\r\ncount_order1=top10(purchase,\"gross-sales\", 3)\r\ncount_order1=top10(purchase,\"gross-sales\", 4)\r\ncount_order1=top10(purchase,\"gross-sales\", 5)\r\ncount_order1=top10(purchase,\"gross-sales\", 6)\r\ncount_order1=top10(purchase,\"gross-sales\", 7)\r\n\r\n\r\n#count_order2=top10(purchase, 2)\r\n#count_order3=top10(purchase, 3)\r\n#count_order4=top10(purchase, 4)\r\n#count_order5=top10(purchase, 5)\r\n#count_order6=top10(purchase, 6)\r\n#count_order7=top10(purchase, 7)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n#count_order=purchase.groupBy(\"dayofWeek\",\"product_id\").agg({'total': 'sum'}).sort(\"dayofweek\",\"sum(total)\", ascending=False).withColumnRenamed('sum(total)', 'sumT').limit(20)\r\n\r\n#count_order.show()\r\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----------+------------------+\n|product_id|       gross-sales|\n+----------+------------------+\n|B00D757UGW|337381.31000000006|\n|1442135263|         278230.31|\n|0989396282|         237984.13|\n|B00RVWG6US|182623.84999999998|\n|1401836674|         180838.57|\n|B00FXJ7NJE|179302.02999999997|\n|B000BME116|167147.25999999998|\n|B00DIF44QU|         165473.37|\n|B000IO4YEG|164383.51000000004|\n|B00LFK2I04|         162462.43|\n+----------+------------------+\n\n+----------+------------------+\n|product_id|       gross-sales|\n+----------+------------------+\n|160796063X|210329.32999999993|\n|B00A5EFXD0|190540.66000000003|\n|B00HV38SM6|177431.68000000002|\n|B004LM3MRQ|         173415.97|\n|B004QDPLVA|162762.27000000002|\n|B001P3098O|161184.71999999997|\n|B000OMCJ4Y|159628.77999999997|\n|B00DRH0E2C|159612.19999999995|\n|B00NTNPK6Y|159132.71999999997|\n|B006C9ERDY|          157874.9|\n+----------+------------------+\n\n+----------+------------------+\n|product_id|       gross-sales|\n+----------+------------------+\n|B00HO9ZRWQ|213574.23999999996|\n|B00GKZETHO|         196787.63|\n|B0035GSY1S|196521.41000000003|\n|B004SGUPAW|         193581.91|\n|B000BB40WC|188008.24999999994|\n|B000075BF0|184438.72999999995|\n|0553562398|177676.83999999997|\n|B000FAJMV8|         176167.59|\n|B00C302X0K|164946.31999999998|\n|B0027IMAGU|         163059.87|\n+----------+------------------+\n\n+----------+------------------+\n|product_id|       gross-sales|\n+----------+------------------+\n|B012VUZ600|         203801.01|\n|B00N9U3LXG|191656.78999999998|\n|B00501IVRS|         185905.78|\n|B00KIB6GLS|179392.79999999993|\n|B0018OQQHI|179252.93999999997|\n|B0046CSM0I|177676.97999999995|\n|B000EG8IEK|175466.56999999998|\n|B00979S04S|174516.07000000004|\n|B00AM1B3L2|174289.37999999998|\n|B000E2AP7W|         173061.66|\n+----------+------------------+\n\n+----------+------------------+\n|product_id|       gross-sales|\n+----------+------------------+\n|B007C4T7RY|         212587.38|\n|5214785224|         181601.35|\n|B003MC38MA|179414.77000000008|\n|B00QNW8FLA|176735.55000000002|\n|B0046R7QPA|         170871.64|\n|B00E1Q6L5C|         166972.69|\n|B00I8MY1TS|         166547.25|\n|B000EFJV4M|          164357.9|\n|B005TPVO2O|         164338.58|\n|B00L84PFLQ|          161316.7|\n+----------+------------------+\n\n+----------+------------------+\n|product_id|       gross-sales|\n+----------+------------------+\n|B000GOVBWG|         281646.06|\n|B000PTZV5U|220708.81999999998|\n|B002L7EFH4|         215449.79|\n|B001B66PGK|         182169.99|\n|B00NIMEEE0|         179159.22|\n|B004HMY9LS|171757.38000000003|\n|B007FMRDQ0|167344.78000000003|\n|B003VM7KRA|         165139.06|\n|B0064PITOE|          161349.9|\n|0871130769|160491.27000000002|\n+----------+------------------+\n\n+----------+------------------+\n|product_id|       gross-sales|\n+----------+------------------+\n|B00CENUEDY|         241213.63|\n|B000195F1E|210004.67999999996|\n|B00JIEXS4O|         205611.44|\n|B00AK43B52|189778.33999999997|\n|B00DRAKM8A|         182845.37|\n|B00FRXTNFS|167551.14000000004|\n|B00MO8BC0S|166167.43000000002|\n|B000E0TS54|         164235.69|\n|B000JJWDWA|         162473.82|\n|B0018DZ5HQ|         159978.93|\n+----------+------------------+\n\n"}]},"apps":[],"jobName":"paragraph_1535315399475_1379516958","id":"20180822-165604_197555793","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:6574"},{"text":"%pyspark\nfrom pyspark import SparkContext\nfrom pyspark.sql import SQLContext\nfrom pyspark.sql.functions import to_timestamp\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.window import Window\n\n#json.loads\npurchase = sqlContext.read.json(\"gs://de-training-input/alimazon/200000/client-orders/part_*.jsonl.gz\")\npurchase = purchase.withColumn(\"parsed1\", substring(\"timestamp\",0,10)).withColumn(\"parsed\", to_date(\"parsed1\", \"yyyy-MM-dd\")).withColumn(\"month\", month(\"parsed\")).withColumn(\"dayofWeek\", date_format(\"parsed\",\"u\"))\npurchase.show()\n\n#dfmon=purchase.groupBy(\"month\",\"product_id\").agg({\"total\": 'sum','product_id':'count'}).withColumnRenamed('count(product_id)', 'orders_count').withColumnRenamed('sum(total)', 'gross-sales').cache()\n\ndef top10n(df ,var, day):\n    dfn=dfpur.sort(var, ascending=False).drop(\"gross-sales\",\"dayofWeek\").filter(dfpur.dayofWeek == day).limit(10)\n    dfn.show()\n    dfn.repartition(1).write.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").mode('overwrite').csv(\"gs://de-training-output-topifloresl/assignment-c3/top10-products-by-orders-spending-\"+str(day)+\".csv\")\n    return dfn\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+--------------------+----------+--------+--------------------+-------+----------+----------+-----+---------+\n|           client_id|                  id|product_id|quantity|           timestamp|  total|   parsed1|    parsed|month|dayofWeek|\n+--------------------+--------------------+----------+--------+--------------------+-------+----------+----------+-----+---------+\n|c786ac28-0069-4fd...|dfab2420-2b2e-4c9...|B00GHS0FI6|      86|2018-05-24T02:43:...|10466.2|2018-05-24|2018-05-24|    5|        4|\n|c786ac28-0069-4fd...|43953223-5a2c-428...|B00II05QWQ|      45|2018-05-27T02:43:...|1030.95|2018-05-27|2018-05-27|    5|        7|\n|c786ac28-0069-4fd...|fe4d5570-8b38-46a...|B00C2UMTIM|      29|2018-06-02T02:43:...|1307.32|2018-06-02|2018-06-02|    6|        6|\n|c786ac28-0069-4fd...|8226c781-b5c9-402...|B000P6CYVW|      29|2018-06-11T02:43:...|2369.01|2018-06-11|2018-06-11|    6|        1|\n|c786ac28-0069-4fd...|1220c004-9773-4f6...|B00BB9DPGK|      84|2018-06-14T02:43:...|3050.04|2018-06-14|2018-06-14|    6|        4|\n|c786ac28-0069-4fd...|99b96283-7f10-43a...|B000MGNY1O|      75|2018-06-20T02:43:...|5259.75|2018-06-20|2018-06-20|    6|        3|\n|c786ac28-0069-4fd...|e8e91317-93f5-487...|3446162445|      26|2018-06-23T02:43:...| 399.62|2018-06-23|2018-06-23|    6|        6|\n|c786ac28-0069-4fd...|9d026c25-2e3d-4fc...|0792242076|      24|2018-06-26T02:43:...| 926.64|2018-06-26|2018-06-26|    6|        2|\n|c786ac28-0069-4fd...|b740795a-5b12-434...|B00CBP3ZCW|      89|2018-06-29T02:43:...|6851.22|2018-06-29|2018-06-29|    6|        5|\n|bc2a9fdd-dfee-4f9...|e56211db-1319-49c...|B00ANZO8V4|      78|2016-08-31T05:02:...|1994.46|2016-08-31|2016-08-31|    8|        3|\n|bc2a9fdd-dfee-4f9...|0353ebc2-c883-440...|B00ECMJNAA|      48|2016-09-13T05:02:...|4431.36|2016-09-13|2016-09-13|    9|        2|\n|bc2a9fdd-dfee-4f9...|05c18416-1536-43b...|B000CZ46GM|      19|2016-09-26T05:02:...| 255.36|2016-09-26|2016-09-26|    9|        1|\n|bc2a9fdd-dfee-4f9...|0112b8cf-10d8-4e9...|B000FJDH92|      88|2016-10-09T05:02:...|1923.68|2016-10-09|2016-10-09|   10|        7|\n|bc2a9fdd-dfee-4f9...|acf1cb80-f180-4d3...|1937727246|      12|2016-10-22T05:02:...|  91.08|2016-10-22|2016-10-22|   10|        6|\n|bc2a9fdd-dfee-4f9...|5d5fbe57-b2e1-46d...|B00KPDU6NS|      62|2016-11-04T05:02:...| 904.58|2016-11-04|2016-11-04|   11|        5|\n|bc2a9fdd-dfee-4f9...|9c1f7933-4e4e-4b9...|B004001C2Q|      82|2016-11-30T05:02:...| 359.98|2016-11-30|2016-11-30|   11|        3|\n|bc2a9fdd-dfee-4f9...|5647fdbe-2001-4bd...|B00BI4HQYA|       7|2016-12-13T05:02:...|   97.3|2016-12-13|2016-12-13|   12|        2|\n|bc2a9fdd-dfee-4f9...|7aa19b13-10e5-421...|B0007WZP1A|      61|2016-12-26T05:02:...| 411.14|2016-12-26|2016-12-26|   12|        1|\n|bc2a9fdd-dfee-4f9...|6951c2c5-3102-4ed...|B00IPSHF1G|       6|2017-01-08T05:02:...| 163.86|2017-01-08|2017-01-08|    1|        7|\n|bc2a9fdd-dfee-4f9...|d8fc6466-2443-492...|B005LVY0XG|      87|2017-01-21T05:02:...| 828.24|2017-01-21|2017-01-21|    1|        6|\n+--------------------+--------------------+----------+--------+--------------------+-------+----------+----------+-----+---------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1535315399487_1374899971","id":"20180822-215059_1154737692","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6575"},{"text":"%pyspark\ncount_order1=top10n(purchase,\"orders_count\", 1)\ncount_order2=top10n(purchase,\"orders_count\", 2)\ncount_order3=top10n(purchase,\"orders_count\", 3)\ncount_order4=top10n(purchase,\"orders_count\", 4)\ncount_order5=top10n(purchase,\"orders_count\", 5)\ncount_order6=top10n(purchase,\"orders_count\", 6)\ncount_order7=top10n(purchase,\"orders_count\", 7)\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----------+------------+\n|product_id|orders_count|\n+----------+------------+\n|B009Q0ILCY|          46|\n|B00BFDDDY6|          46|\n|B00A8D3T1Q|          45|\n|1938235002|          44|\n|B000VLD7QW|          44|\n|B00AEH3FJM|          44|\n|8466642498|          44|\n|B000SIG198|          43|\n|B004NOSHIQ|          43|\n|B008G53UJ4|          43|\n+----------+------------+\n\n+----------+------------+\n|product_id|orders_count|\n+----------+------------+\n|B00BLMRTUK|          49|\n|B00851IXOQ|          47|\n|B0098QTW2Y|          46|\n|B00J8WJAA2|          45|\n|B0073YAO02|          44|\n|B005NGZ3OY|          44|\n|0989029395|          43|\n|B00NJ3WVUC|          43|\n|B00CIMK6E8|          43|\n|0473150956|          43|\n+----------+------------+\n\n+----------+------------+\n|product_id|orders_count|\n+----------+------------+\n|B009OHOGL4|          46|\n|B001L1KS9A|          45|\n|B00G9A76EI|          45|\n|B00RD5E3GW|          45|\n|B00L5GR5E2|          44|\n|B00PAT0MHM|          44|\n|B00BOA6ND8|          44|\n|B00FZMTNDI|          44|\n|B00M9W4B98|          44|\n|B000NYIVYK|          43|\n+----------+------------+\n\n+----------+------------+\n|product_id|orders_count|\n+----------+------------+\n|B0060JJLXC|          50|\n|B0017TGH32|          46|\n|1932266836|          45|\n|B003M61QVG|          44|\n|B00J0UXNJQ|          44|\n|B0081M5MP2|          44|\n|B00B2GE7CI|          43|\n|B000JZD7UQ|          43|\n|B00FPYN83M|          43|\n|B00FBWDWXE|          43|\n+----------+------------+\n\n+----------+------------+\n|product_id|orders_count|\n+----------+------------+\n|0195076362|          46|\n|B00EKZ5I8K|          46|\n|B000FGZIPQ|          46|\n|B00BD3LG9W|          45|\n|B0002XIR3M|          44|\n|B00I1AIHGU|          44|\n|B002T3MQHG|          43|\n|019509252X|          43|\n|B0078L397K|          43|\n|B00F3UR87K|          43|\n+----------+------------+\n\n+----------+------------+\n|product_id|orders_count|\n+----------+------------+\n|B009ZCY2NA|          47|\n|B00LW97S8K|          46|\n|B0048S7KCQ|          46|\n|0373484461|          45|\n|1853595640|          45|\n|B006ODI0OU|          45|\n|B00MYGP15W|          45|\n|B004CO109K|          45|\n|B0086A108M|          44|\n|B00KLN2V58|          44|\n+----------+------------+\n\n+----------+------------+\n|product_id|orders_count|\n+----------+------------+\n|B008A2VYIM|          48|\n|B0085UPU48|          47|\n|0395971047|          46|\n|B00LVT5PHM|          45|\n|B004LEWK0Y|          45|\n|0142425125|          45|\n|B00KGE6D56|          44|\n|0557021839|          44|\n|B00EJ7NQJ2|          44|\n|0814334997|          44|\n+----------+------------+\n\n"}]},"apps":[],"jobName":"paragraph_1535315399489_1360279513","id":"20180822-214957_1882911083","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6576"},{"text":"%pyspark\ntt1 =purchase.filter(purchase.month == 1).groupBy(\"client_id\").agg({\"total\": 'sum','client_id':'count'}).withColumnRenamed('count(client_id)', 'orders_count').withColumnRenamed('sum(total)', 'gross-sales').sort('gross-sales', ascending=False).limit(10)\ntt1.show()\n\ntt2= purchase.filter(purchase.month == 2).groupBy(\"client_id\").agg({\"total\": 'sum','client_id':'count'}).withColumnRenamed('count(client_id)', 'orders_count').withColumnRenamed('sum(total)', 'gross-sales').sort('gross-sales', ascending=False).limit(10)\ntt2.show()","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+------------------+------------+\n|           client_id|       gross-sales|orders_count|\n+--------------------+------------------+------------+\n|84d06e1b-1cb6-43c...|         266350.07|           5|\n|cac0cb1a-d1c6-4cf...|         241396.88|           9|\n|f05ac112-6bc1-4ec...|185911.90000000002|          25|\n|6ea35b93-1b98-499...|         177161.98|          10|\n|054156bf-ae11-4ce...|167553.66999999995|          27|\n|e9cffa3b-90c0-4a9...|164730.04000000004|          27|\n|8c233f0b-280e-437...|161507.23000000004|          25|\n|313b5b7d-9ce8-41a...|         155988.94|          27|\n|a9f629fd-04c9-400...|         154824.63|          30|\n|143dcbd8-a94b-45e...|153332.34000000003|          25|\n+--------------------+------------------+------------+\n\n+--------------------+------------------+------------+\n|           client_id|       gross-sales|orders_count|\n+--------------------+------------------+------------+\n|0d5945bf-f927-463...|         177169.59|           7|\n|46ed88ba-0de1-4a6...|         170310.75|          27|\n|0a4f1443-1288-4fe...|         170051.02|          31|\n|1b475c19-04e2-43d...|         148053.11|           5|\n|07571a21-4c67-42c...|145764.08000000002|          36|\n|2481d388-8a59-447...|         145670.34|           5|\n|a0d2997b-b545-4b2...|         143701.08|          15|\n|a40fba4e-e68f-453...|         139909.64|          17|\n|7ec6e54a-bdde-4a1...|         137552.75|          24|\n|1f6ab4da-a560-4cc...|         136881.28|          32|\n+--------------------+------------------+------------+\n\n"}]},"apps":[],"jobName":"paragraph_1535315399493_1358740517","id":"20180824-205755_682326758","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6577"},{"text":"%pyspark\n\ndfpurt=purchase.groupBy(\"month\",\"client_id\").agg({\"total\": 'sum','client_id':'count'}).withColumnRenamed('count(client_id)', 'orders_count').withColumnRenamed('sum(total)', 'gross-sales').cache()\n\n\n\n\ndef top10c(df ,var, day):\n    dfn=dfpurt.sort(var, ascending=False).drop(\"orders_count\",\"month\").filter(dfpurt.month == day).limit(10)\n    dfn.show()\n    dfn.repartition(1).write.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").mode('overwrite').csv(\"gs://de-training-output-topifloresl/assignment-c3/top10-customers-by-gross-spending-\"+str(day)+\".csv\")\n    return dfn\n\ncount_order1=top10c(dfpurt,\"gross-sales\", 1)\ncount_order2=top10c(dfpurt,\"gross-sales\", 2)\ncount_order3=top10c(dfpurt,\"gross-sales\", 3)\ncount_order4=top10c(dfpurt,\"gross-sales\", 4)\ncount_order5=top10c(dfpurt,\"gross-sales\", 5)\ncount_order6=top10c(dfpurt,\"gross-sales\", 6)\ncount_order7=top10c(dfpurt,\"gross-sales\", 7)\ncount_order4=top10c(dfpurt,\"gross-sales\", 8)\ncount_order5=top10c(dfpurt,\"gross-sales\", 9)\ncount_order6=top10c(dfpurt,\"gross-sales\", 10)\ncount_order7=top10c(dfpurt,\"gross-sales\", 11)\ncount_order7=top10c(dfpurt,\"gross-sales\", 12)\n\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|84d06e1b-1cb6-43c...|         266350.07|\n|cac0cb1a-d1c6-4cf...|         241396.88|\n|f05ac112-6bc1-4ec...|185911.90000000002|\n|6ea35b93-1b98-499...|         177161.98|\n|054156bf-ae11-4ce...|167553.66999999995|\n|e9cffa3b-90c0-4a9...|164730.04000000004|\n|8c233f0b-280e-437...|161507.23000000004|\n|313b5b7d-9ce8-41a...|         155988.94|\n|a9f629fd-04c9-400...|         154824.63|\n|143dcbd8-a94b-45e...|153332.34000000003|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|0d5945bf-f927-463...|         177169.59|\n|46ed88ba-0de1-4a6...|         170310.75|\n|0a4f1443-1288-4fe...|         170051.02|\n|1b475c19-04e2-43d...|         148053.11|\n|07571a21-4c67-42c...|145764.08000000002|\n|2481d388-8a59-447...|         145670.34|\n|a0d2997b-b545-4b2...|         143701.08|\n|a40fba4e-e68f-453...|         139909.64|\n|7ec6e54a-bdde-4a1...|         137552.75|\n|1f6ab4da-a560-4cc...|         136881.28|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|379c0acb-f3c1-40a...|178195.16999999998|\n|0ee08e9d-d4a0-4c6...|167094.21999999997|\n|89a4910b-74b7-430...|         162216.35|\n|41cecbef-5666-486...|         161632.77|\n|8f05a45b-2b16-4bd...|         159663.69|\n|2d1029d8-d655-438...|158463.03999999998|\n|fc55f25d-2b8a-46a...|         157242.03|\n|275e9683-86d1-472...|         155096.82|\n|5c9577f5-2060-462...|153018.24000000002|\n|2eeed5c4-4f15-4fc...|152034.56000000003|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|4a165817-4689-4f2...|         288437.66|\n|a8137cf2-008a-400...|         217705.94|\n|b4e2f385-c262-4b3...|         209515.77|\n|df8280a5-9bc4-4db...|179391.50999999998|\n|0a8ae703-eed7-4de...|170016.65999999997|\n|a38b17f2-e804-401...|         169886.97|\n|b48f942b-2906-419...|163404.55999999997|\n|60e1e671-3a1e-4fb...|          162845.0|\n|e348836e-7ed2-40b...|         161819.34|\n|9f80db6b-4fe2-4f3...|159193.53999999998|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|b90da7d3-d205-41d...|203550.92999999996|\n|76260611-af93-48f...|174431.53999999998|\n|6f4cef5b-0cf8-40a...|         173881.97|\n|5cac7be1-4541-497...|         171563.86|\n|50c0c501-1ee7-48a...|169015.18999999997|\n|b217524c-776a-45e...|163394.60999999996|\n|e7ffa2ce-bf43-42c...|160885.81999999998|\n|3541635c-e93c-4bd...|157061.74999999994|\n|655f8021-dab5-4e8...|         147614.08|\n|13c3b236-5730-416...|146927.20999999996|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|b1f06797-fc24-4c3...|         191975.49|\n|c13336ca-27ff-4ff...|186313.77999999997|\n|7a818e2b-d714-4b2...|176159.44999999998|\n|69b50f96-b255-47f...|175860.05000000002|\n|6cc99c8e-a96b-46e...|171172.27999999997|\n|120eaa45-719a-481...|169785.09999999995|\n|c43cec2d-6f10-4cb...|         162225.64|\n|07382db1-5f70-4c5...|         153626.99|\n|a27fb31e-2b9a-4a5...|151405.77000000002|\n|01eedd91-08e8-457...|150254.63999999998|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|2d7bd286-bca2-461...|223830.00999999998|\n|ffa941ce-37dd-425...|         165653.14|\n|4abad71b-559e-458...|164232.59999999998|\n|65f95656-1bbf-4c1...|149110.37999999998|\n|a537c823-a65d-440...|          146251.0|\n|578dda64-5685-487...|         139346.39|\n|05881573-dd14-47a...|         139221.66|\n|24631d7c-022c-459...|         138760.08|\n|73ed4939-dc80-431...|          131280.1|\n|1a9d809f-e36e-462...|130480.62000000002|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|04ff8a40-d7ab-41c...|         180241.14|\n|e9e9aa04-0df8-42d...|152450.26000000004|\n|8dc001d0-8bd7-484...|151379.92999999993|\n|91e74dd8-0cfa-4ee...|150449.77000000005|\n|b2f0aa52-0c7e-41a...|137340.96000000002|\n|1ddb8201-9036-4f8...|136415.94000000003|\n|5f0fae4f-01a9-4a4...|         135970.65|\n|dd1db661-0e25-4a1...|135575.97000000003|\n|3043f5a3-0cf0-49a...|135204.97999999998|\n|051b9240-ee6a-444...|130547.17000000003|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|84c496a2-6192-444...|         174514.34|\n|225d2669-1ac7-401...|164819.55000000002|\n|0c60c231-0f77-436...|         155292.99|\n|94c97a4c-76dc-495...|150966.93999999997|\n|bc4eab83-1888-447...|         141540.95|\n|d8c023b0-1d6b-457...|141516.72999999995|\n|424068d1-b63c-46f...|         138260.52|\n|bd66d355-a622-493...|         132920.21|\n|8eae6863-e39a-4e6...|         131148.73|\n|51c348b3-3bfa-445...|129800.72000000002|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|4e7fcdf0-fafa-49c...|          181997.9|\n|baa875ef-7725-425...|         161452.03|\n|9a605cf6-e9e3-4b1...|160962.36000000002|\n|e93e6414-9611-417...|          160151.4|\n|5cb4ba49-3465-49a...|         158301.82|\n|cde0fda6-04e8-41e...|         156765.25|\n|b6a2e02c-d51c-45f...|149479.46999999994|\n|664c5cfc-871f-483...|142810.77999999997|\n|ac4b1492-f7d4-4ff...|142174.67999999996|\n|4566421d-98b1-45f...|         136743.86|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|ca2279cc-2438-469...|         279508.02|\n|c1717baa-3f17-454...|         203748.91|\n|ed63a172-cd29-4f2...|          201100.7|\n|ca6da26d-4cc3-4ed...|191269.92000000004|\n|33431cc8-6fbb-451...|         186450.74|\n|bb1ac69d-10fa-46c...|164490.43999999997|\n|bbec7930-36cb-4e9...|161187.84000000003|\n|dc01a63a-9c1a-445...|142506.69000000003|\n|872a5045-7803-4c1...|140737.75999999998|\n|9da35b85-d91f-434...|          138942.9|\n+--------------------+------------------+\n\n+--------------------+------------------+\n|           client_id|       gross-sales|\n+--------------------+------------------+\n|440108d6-958f-43b...|192405.66999999998|\n|cd497fd2-0ea6-41c...|185682.89000000004|\n|46e35f14-f104-4ea...|176595.50000000006|\n|63ed9dc0-e4df-43a...|159378.78000000003|\n|0e568af5-cdef-405...|142528.45000000004|\n|9c44f659-a064-448...|         141262.88|\n|4f3cdca7-dc39-42b...|137890.78000000003|\n|ff868f68-2f67-430...|132913.17999999996|\n|4a2581eb-402d-4b6...|         131559.55|\n|a46c5232-1258-4bd...|          128727.2|\n+--------------------+------------------+\n\n"}]},"apps":[],"jobName":"paragraph_1535315399495_1359510015","id":"20180822-221320_1850559091","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6578"},{"text":"%pyspark\ndef top10cn(df ,var, day):\n    dfn=dfpurt.sort(var, ascending=False).drop(\"gross-sales\",\"month\").filter(dfpurt.month == day).limit(10)\n    dfn.show()\n    dfn.repartition(1).write.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").mode('overwrite').csv(\"gs://de-training-output-topifloresl/assignment-c3/top10-customers-by-orders-spending-\"+str(day)+\".csv\")\n    return dfn\n\ncount_order1=top10cn(purchase,\"orders_count\", 1)\ncount_order2=top10cn(purchase,\"orders_count\", 2)\ncount_order3=top10cn(purchase,\"orders_count\", 3)\ncount_order4=top10cn(purchase,\"orders_count\", 4)\ncount_order5=top10cn(purchase,\"orders_count\", 5)\ncount_order6=top10cn(purchase,\"orders_count\", 6)\ncount_order7=top10cn(purchase,\"orders_count\", 7)\ncount_order4=top10cn(purchase,\"orders_count\", 8)\ncount_order5=top10cn(purchase,\"orders_count\", 9)\ncount_order6=top10cn(purchase,\"orders_count\", 10)\ncount_order7=top10cn(purchase,\"orders_count\", 11)\ncount_order7=top10cn(purchase,\"orders_count\", 11)","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|770e0c80-6b43-47c...|          40|\n|bcc7545a-5323-4fe...|          40|\n|0526bb01-0f1c-467...|          39|\n|c47b8ece-350b-447...|          39|\n|7a56520b-45e1-4d1...|          39|\n|345c38c9-ca79-4b9...|          39|\n|f29a7324-a7e6-4c5...|          39|\n|164a28cd-98a5-4fa...|          39|\n|55ec9af5-f7a7-4e8...|          39|\n|aec94716-8c69-478...|          39|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|226fe656-6a83-4a2...|          38|\n|0158136c-ffe6-4b9...|          38|\n|3ca86fa5-5c73-43e...|          37|\n|b8b3a7ad-0bd9-48f...|          37|\n|affcf120-4feb-45f...|          37|\n|1f6a9f5c-9f7a-4ef...|          37|\n|ddfe0727-e7ae-47c...|          37|\n|642bb4f1-ef41-4b5...|          37|\n|eed61023-b3df-40a...|          37|\n|131cd4c1-49a0-40d...|          37|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|19ddec6f-150e-4e4...|          41|\n|d4051def-a5fc-459...|          41|\n|f8298041-7663-473...|          41|\n|07c475cc-594a-4cd...|          41|\n|a099f136-d96f-422...|          41|\n|d5baf963-9b60-448...|          41|\n|5e76c278-eb76-486...|          41|\n|8e35e324-43e8-465...|          41|\n|e7878ba4-c47c-4f8...|          41|\n|20bdaec5-696c-497...|          41|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|84720371-bba0-410...|          40|\n|5685aa5f-5e2f-45b...|          40|\n|15dc4d52-8468-4c5...|          39|\n|67a290cf-1344-4da...|          39|\n|eab77953-97d1-4a7...|          39|\n|76c9e674-1b57-4da...|          39|\n|9b8c57ca-cf95-422...|          39|\n|fb26759a-fd99-490...|          39|\n|7c7bb517-e981-471...|          39|\n|13f21664-a072-4f6...|          39|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|0ca30e4d-9ad4-40c...|          42|\n|11bf6e4c-501f-44d...|          42|\n|7a56520b-45e1-4d1...|          42|\n|198ef283-41a9-403...|          41|\n|5280252d-6484-483...|          41|\n|d7387e60-b56a-414...|          41|\n|03e9464b-616d-405...|          41|\n|f71c97ee-57cf-475...|          41|\n|d5fb519a-4f80-4d6...|          41|\n|6bf1bfc6-25b3-4dd...|          41|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|16226b57-dd67-452...|          40|\n|301c6f7f-2698-49f...|          40|\n|9ff3acd3-90b0-471...|          40|\n|69fed0b1-5de7-415...|          40|\n|ea6426e3-b23c-415...|          40|\n|f7cb49ba-1add-4a8...|          40|\n|d17eee12-0f57-42c...|          40|\n|34f3b71d-c1fa-451...|          40|\n|e57d5156-6d0d-425...|          40|\n|0f5cf19c-5f3a-45e...|          39|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|9c8371f8-1878-400...|          32|\n|7739b88d-35ef-45d...|          32|\n|13510ccb-f761-431...|          32|\n|a8d2ab94-083d-448...|          32|\n|d570aa67-4d53-48d...|          32|\n|2ea413bf-0ebe-4ab...|          32|\n|09b52d97-5267-4d4...|          32|\n|41a2f0d7-07c5-494...|          32|\n|22e54c15-7e47-4c6...|          32|\n|bbce99c8-d5c1-4e7...|          32|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|a8140e55-7dff-456...|          32|\n|241a729b-6ffa-4e1...|          32|\n|75997833-a90e-482...|          32|\n|8d621020-93c8-474...|          32|\n|2c00fc71-2dc0-453...|          32|\n|5dfeff33-c1e3-4f0...|          32|\n|9fac595e-6174-4dc...|          32|\n|f27338f7-0607-426...|          32|\n|b67deacd-12e2-4b0...|          32|\n|612da147-ea8e-4d2...|          32|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|23f6cd75-ef12-4f5...|          30|\n|63d7855d-4108-4dd...|          30|\n|909fd12a-85b1-4c3...|          30|\n|a527d312-3a1b-4dd...|          30|\n|e6d545c7-595a-4e4...|          30|\n|5d61412d-282c-40a...|          30|\n|72d88ab3-2bec-4ea...|          30|\n|1ebe09a0-7fc6-4e0...|          30|\n|73c6a7fe-321a-408...|          30|\n|f009877d-eb0b-43c...|          30|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|b8c033fc-b410-490...|          32|\n|e21bc9e8-f454-44a...|          32|\n|da2ba952-e83a-4ea...|          32|\n|572046c7-c156-471...|          32|\n|5ed6060f-9ade-41a...|          32|\n|1469f61e-1bc5-4d5...|          32|\n|6ff881ad-9722-411...|          32|\n|c9db3577-5fee-45b...|          32|\n|5d655699-5f89-434...|          32|\n|19648ecb-92ed-469...|          32|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|4c4292d6-1aa5-4f4...|          30|\n|074d99cf-f400-4e8...|          30|\n|82071229-dff3-4bd...|          30|\n|ff694237-4cec-49e...|          30|\n|a7294220-35d4-4cf...|          30|\n|b6787a11-3f8f-43f...|          30|\n|d8564562-0f24-4bc...|          30|\n|84ed2a35-2b38-43c...|          30|\n|4daf0c47-ddcf-483...|          30|\n|bdbbc726-3b25-42c...|          30|\n+--------------------+------------+\n\n+--------------------+------------+\n|           client_id|orders_count|\n+--------------------+------------+\n|4c4292d6-1aa5-4f4...|          30|\n|b6787a11-3f8f-43f...|          30|\n|82071229-dff3-4bd...|          30|\n|a7294220-35d4-4cf...|          30|\n|074d99cf-f400-4e8...|          30|\n|4daf0c47-ddcf-483...|          30|\n|d8564562-0f24-4bc...|          30|\n|ff694237-4cec-49e...|          30|\n|84ed2a35-2b38-43c...|          30|\n|f4ad9786-976f-420...|          30|\n+--------------------+------------+\n\n"}]},"apps":[],"jobName":"paragraph_1535315399497_1357201521","id":"20180822-222239_1179113781","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6579"},{"text":"%pyspark\n\ntt1 =purchase.filter(purchase.month == 1).groupBy(\"client_id\").agg({\"total\": 'sum','client_id':'count'}).withColumnRenamed('count(client_id)', 'orders_count').withColumnRenamed('sum(total)', 'gross-sales').sort('orders_count', ascending=False).limit(10)\ntt1.show()\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+------------------+------------+\n|           client_id|       gross-sales|orders_count|\n+--------------------+------------------+------------+\n|bcc7545a-5323-4fe...|         108327.77|          40|\n|770e0c80-6b43-47c...| 47113.88999999999|          40|\n|7a56520b-45e1-4d1...| 44169.79000000001|          39|\n|164a28cd-98a5-4fa...|61041.729999999996|          39|\n|63148291-607a-4ce...| 72894.03999999998|          39|\n|0526bb01-0f1c-467...|          84213.39|          39|\n|aec94716-8c69-478...|136637.00999999998|          39|\n|f29a7324-a7e6-4c5...|          71384.57|          39|\n|c47b8ece-350b-447...| 68096.78000000001|          39|\n|b60bd0c0-fc81-4b2...| 79935.39000000001|          39|\n+--------------------+------------------+------------+\n\n"}]},"apps":[],"jobName":"paragraph_1535315399498_1358355768","id":"20180824-211125_1227644264","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6580"},{"text":"%md\n##`Assign 4`  Super\n\nLets work on this\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>##<code>Assign 4</code> Super</p>\n<p>Lets work on this</p>\n</div>"}]},"apps":[],"jobName":"paragraph_1535315399499_1357971019","id":"20180824-213030_1750321011","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6581"},{"text":"%pyspark\r\n\r\nfrom pyspark import SparkContext\r\nfrom pyspark.sql import SQLContext\r\nfrom pyspark.sql.functions import to_timestamp\r\nfrom pyspark.sql.functions import *\r\nfrom pyspark.sql.window import Window\r\n\r\n\r\n#json.loads\r\npurchase= sqlContext.read.json(\"gs://de-training-input/alimazon/200000/client-orders/part_*.jsonl.gz\")\r\nfilenew= purchase.withColumn(\"hour\", substring(\"timestamp\", 12,2).cast(\"int\")).withColumn(\"parsed1\", substring(\"timestamp\",0,10)).withColumn(\"parsed\", to_date(\"parsed1\", \"yyyy-MM-dd\")).withColumn(\"dayofWeek\", date_format(\"parsed\",\"u\")).withColumn(\"total1\", purchase.total).withColumn(\"total2\", purchase.total)\r\nfilenew.show()\r\n\r\nhourt=filenew.groupBy(\"hour\").agg({\"total\": 'avg','total1':'min', \"total2\":\"max\"}).withColumnRenamed('avg(total)', 'average').withColumnRenamed('min(total1)', 'min_spending').withColumnRenamed('max(total2)', 'max_spending').sort('average', ascending=False).withColumn(\"average_spending\",round(\"average\",2)).drop(\"average\")\r\n\r\nhourt.show()\r\n\r\nhourt.select(\"hour\",\"average_spending\",\"min_spending\",\"max_spending\").coalesce(1).sortWithinPartitions(\"average_spending\", ascending=False).write.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").mode('overwrite').csv(\"gs://de-training-output-topifloresl/assignment-4-best_selling_hours-1\")\r\n\r\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+--------------------+----------+--------+--------------------+-------+----+----------+----------+---------+-------+-------+\n|           client_id|                  id|product_id|quantity|           timestamp|  total|hour|   parsed1|    parsed|dayofWeek| total1| total2|\n+--------------------+--------------------+----------+--------+--------------------+-------+----+----------+----------+---------+-------+-------+\n|c786ac28-0069-4fd...|dfab2420-2b2e-4c9...|B00GHS0FI6|      86|2018-05-24T02:43:...|10466.2|   2|2018-05-24|2018-05-24|        4|10466.2|10466.2|\n|c786ac28-0069-4fd...|43953223-5a2c-428...|B00II05QWQ|      45|2018-05-27T02:43:...|1030.95|   2|2018-05-27|2018-05-27|        7|1030.95|1030.95|\n|c786ac28-0069-4fd...|fe4d5570-8b38-46a...|B00C2UMTIM|      29|2018-06-02T02:43:...|1307.32|   2|2018-06-02|2018-06-02|        6|1307.32|1307.32|\n|c786ac28-0069-4fd...|8226c781-b5c9-402...|B000P6CYVW|      29|2018-06-11T02:43:...|2369.01|   2|2018-06-11|2018-06-11|        1|2369.01|2369.01|\n|c786ac28-0069-4fd...|1220c004-9773-4f6...|B00BB9DPGK|      84|2018-06-14T02:43:...|3050.04|   2|2018-06-14|2018-06-14|        4|3050.04|3050.04|\n|c786ac28-0069-4fd...|99b96283-7f10-43a...|B000MGNY1O|      75|2018-06-20T02:43:...|5259.75|   2|2018-06-20|2018-06-20|        3|5259.75|5259.75|\n|c786ac28-0069-4fd...|e8e91317-93f5-487...|3446162445|      26|2018-06-23T02:43:...| 399.62|   2|2018-06-23|2018-06-23|        6| 399.62| 399.62|\n|c786ac28-0069-4fd...|9d026c25-2e3d-4fc...|0792242076|      24|2018-06-26T02:43:...| 926.64|   2|2018-06-26|2018-06-26|        2| 926.64| 926.64|\n|c786ac28-0069-4fd...|b740795a-5b12-434...|B00CBP3ZCW|      89|2018-06-29T02:43:...|6851.22|   2|2018-06-29|2018-06-29|        5|6851.22|6851.22|\n|bc2a9fdd-dfee-4f9...|e56211db-1319-49c...|B00ANZO8V4|      78|2016-08-31T05:02:...|1994.46|   5|2016-08-31|2016-08-31|        3|1994.46|1994.46|\n|bc2a9fdd-dfee-4f9...|0353ebc2-c883-440...|B00ECMJNAA|      48|2016-09-13T05:02:...|4431.36|   5|2016-09-13|2016-09-13|        2|4431.36|4431.36|\n|bc2a9fdd-dfee-4f9...|05c18416-1536-43b...|B000CZ46GM|      19|2016-09-26T05:02:...| 255.36|   5|2016-09-26|2016-09-26|        1| 255.36| 255.36|\n|bc2a9fdd-dfee-4f9...|0112b8cf-10d8-4e9...|B000FJDH92|      88|2016-10-09T05:02:...|1923.68|   5|2016-10-09|2016-10-09|        7|1923.68|1923.68|\n|bc2a9fdd-dfee-4f9...|acf1cb80-f180-4d3...|1937727246|      12|2016-10-22T05:02:...|  91.08|   5|2016-10-22|2016-10-22|        6|  91.08|  91.08|\n|bc2a9fdd-dfee-4f9...|5d5fbe57-b2e1-46d...|B00KPDU6NS|      62|2016-11-04T05:02:...| 904.58|   5|2016-11-04|2016-11-04|        5| 904.58| 904.58|\n|bc2a9fdd-dfee-4f9...|9c1f7933-4e4e-4b9...|B004001C2Q|      82|2016-11-30T05:02:...| 359.98|   5|2016-11-30|2016-11-30|        3| 359.98| 359.98|\n|bc2a9fdd-dfee-4f9...|5647fdbe-2001-4bd...|B00BI4HQYA|       7|2016-12-13T05:02:...|   97.3|   5|2016-12-13|2016-12-13|        2|   97.3|   97.3|\n|bc2a9fdd-dfee-4f9...|7aa19b13-10e5-421...|B0007WZP1A|      61|2016-12-26T05:02:...| 411.14|   5|2016-12-26|2016-12-26|        1| 411.14| 411.14|\n|bc2a9fdd-dfee-4f9...|6951c2c5-3102-4ed...|B00IPSHF1G|       6|2017-01-08T05:02:...| 163.86|   5|2017-01-08|2017-01-08|        7| 163.86| 163.86|\n|bc2a9fdd-dfee-4f9...|d8fc6466-2443-492...|B005LVY0XG|      87|2017-01-21T05:02:...| 828.24|   5|2017-01-21|2017-01-21|        6| 828.24| 828.24|\n+--------------------+--------------------+----------+--------+--------------------+-------+----+----------+----------+---------+-------+-------+\nonly showing top 20 rows\n\n+----+------------+------------+----------------+\n|hour|min_spending|max_spending|average_spending|\n+----+------------+------------+----------------+\n|   3|        1.01|   154667.47|         1665.49|\n|   1|        1.02|   169256.12|         1663.56|\n|   8|         1.0|   131545.92|         1662.92|\n|  23|        1.04|   139304.24|         1662.33|\n|   4|         1.0|   163469.79|          1661.2|\n|   6|        1.08|   132025.32|         1660.62|\n|  16|        1.02|   127699.95|         1659.26|\n|  15|        1.11|   167105.19|          1658.7|\n|  10|         1.0|    158118.0|         1658.09|\n|   9|        1.01|   174890.13|         1657.37|\n|  19|        1.03|    138207.0|         1656.93|\n|  18|        1.12|    194409.6|         1656.87|\n|   2|        1.03|   143481.96|         1656.63|\n|  17|        1.03|   117766.32|          1656.5|\n|   0|        1.05|   149114.34|         1656.01|\n|  12|         1.0|   136396.26|         1655.84|\n|  14|        1.02|    228091.5|         1655.78|\n|   7|        1.02|   154722.24|         1655.47|\n|  13|        1.03|   115666.31|         1655.22|\n|  11|         1.0|   227290.05|          1654.8|\n+----+------------+------------+----------------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1535315399501_1355662526","id":"20180824-213029_74916078","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6582"},{"text":"%pyspark\n\nfrom pyspark import SparkContext\nfrom pyspark.sql import SQLContext\nfrom pyspark.sql.functions import to_timestamp\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.window import Window\nfrom pyspark.sql.functions import *\nfrom pyspark.sql import *\n\n#product_id, total_products_sold, total_registered_sales, unit_product_price,new_unit_product_price\n\n#json.loads\npurchase1= sqlContext.read.json(\"gs://de-training-input/alimazon/200000/client-orders/part_*.jsonl.gz\")\nmax_Date=purchase1.withColumn(\"parsed1\", substring(\"timestamp\",0,10)).withColumn(\"parsed\", to_date(\"parsed1\", \"yyyy-MM-dd\")).agg({\"parsed\": 'max','total':'sum'}).select(\"max(parsed)\").collect()[0]\nmaxidate=max_Date[\"max(parsed)\"]\n\nprint maxidate\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"2018-06-30\n"}]},"apps":[],"jobName":"paragraph_1535315399502_1356816773","id":"20180825-223211_727713666","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6583"},{"text":"%pyspark\n\nfrom pyspark import SparkContext\nfrom pyspark.sql import SQLContext\nfrom pyspark.sql.functions import to_timestamp\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.window import Window\nfrom pyspark.sql.functions import *\n\n#product_id, total_products_sold, total_registered_sales, unit_product_price,new_unit_product_price\n\n#json.loads\npurchase1= sqlContext.read.json(\"gs://de-training-input/alimazon/200000/client-orders/part_*.jsonl.gz\")\n#current_date()\n\n\nfilenew= purchase1.withColumn(\"parsed1\", substring(\"timestamp\",0,10)).withColumn(\"parsed\", to_date(\"parsed1\", \"yyyy-MM-dd\")).withColumn(\"filer\", months_between(to_date(lit('2018-06-30'),\"yyyy-MM-dd\"),\"parsed1\")).withColumn(\"Price\", round(purchase1.total/purchase1.quantity,2)).cache()\n\n\n#filenew.sort('product_id', ascending=True).show()\n\nfilen = filenew.filter(filenew.filer<=6).groupBy(\"product_id\").agg({\"quantity\": 'sum','total':'sum'}).withColumnRenamed('sum(quantity)', 'total_products_sold').withColumnRenamed('sum(total)', 'total_registered_sales').sort(\"total_registered_sales\", ascending=False).limit(10)\n\ntte=filen.withColumn(\"unit_product_price\", round(filen.total_registered_sales/filen.total_products_sold,2)).withColumn(\"new_unit_product_price\",round( (filen.total_registered_sales/filen.total_products_sold)*0.9,2))\n\ntte.show()\ntte.coalesce(1).sortWithinPartitions(\"total_products_sold\", ascending=False).write.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").mode('overwrite').csv(\"gs://de-training-output-topifloresl/assignment-4-monthly_disscount-1\")\n#filenew.sort('product_id', ascending=True).show()\n\n\n\n","user":"anonymous","dateUpdated":"2018-08-26T20:30:51+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----------+----------------------+-------------------+------------------+----------------------+\n|product_id|total_registered_sales|total_products_sold|unit_product_price|new_unit_product_price|\n+----------+----------------------+-------------------+------------------+----------------------+\n|B00CENUEDY|             271179.59|               1589|            170.66|                153.59|\n|B00GKZETHO|    238681.52999999997|               2547|             93.71|                 84.34|\n|B00RVWG6US|    235215.60999999993|               2204|            106.72|                 96.05|\n|B000195F1E|    223712.93999999997|               1346|            166.21|                149.59|\n|B004FKBTZG|    222828.91000000003|               2429|             91.74|                 82.56|\n|B003CIPQ3I|    219650.41999999995|               2924|             75.12|                 67.61|\n|B00N9U3LXG|    219482.49000000002|               2179|            100.73|                 90.65|\n|B00L84PFLQ|    218801.47000000003|               3277|             66.77|                 60.09|\n|B000075BF0|    218696.63000000006|               2435|             89.81|                 80.83|\n|B00501IVRS|    214318.44000000003|               1911|            112.15|                100.93|\n+----------+----------------------+-------------------+------------------+----------------------+\n\n"}]},"apps":[],"jobName":"paragraph_1535315399504_1366820244","id":"20180824-225434_1590453676","dateCreated":"2018-08-26T20:29:59+0000","dateStarted":"2018-08-26T20:30:51+0000","dateFinished":"2018-08-26T20:39:50+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:6584"},{"text":"%pyspark\nr=filenew.agg({\"timehour\": 'min'})\nr.show()","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-------------+\n|min(timehour)|\n+-------------+\n|            0|\n+-------------+\n\n"}]},"apps":[],"jobName":"paragraph_1535315399505_1366435495","id":"20180824-215621_645307780","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6585"},{"text":"%pyspark\n\nfrom pyspark import SparkContext\nfrom pyspark.sql import SQLContext\nfrom pyspark.sql.functions import to_timestamp\nfrom pyspark.sql.functions import *\nfrom pyspark.sql.window import Window\nfrom pyspark.sql.functions import *\n\n#product_id, total_products_sold, total_registered_sales, unit_product_price,new_unit_product_price\n\n#json.loads\npurchase2= sqlContext.read.json(\"gs://de-training-input/alimazon/200000/client-orders/part_*.jsonl.gz\")\nfiledst= purchase2.groupBy(\"client_id\").agg({\"quantity\": 'sum'}).withColumnRenamed('sum(quantity)', 'products_count')\n\n\n\nttt=filedst.groupBy(\"products_count\").agg({\"products_count\": 'count'}).withColumnRenamed('count(products_count)', 'clients_count')\n\nttt.show()\nttt.coalesce(1).sortWithinPartitions(\"clients_count\", ascending=True).write.format(\"com.databricks.spark.csv\").option(\"header\", \"true\").mode('overwrite').csv(\"gs://de-training-output-topifloresl/assignment-4-client_orders_dist-1\")\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------+-------------+\n|products_count|clients_count|\n+--------------+-------------+\n|          1697|           56|\n|         11938|            6|\n|          2214|           39|\n|          2927|           32|\n|          2509|           32|\n|          2453|           38|\n|         15432|            3|\n|          2250|           38|\n|          3506|           26|\n|          7279|            2|\n|          2040|           52|\n|         16530|            2|\n|           964|           52|\n|           474|           59|\n|         14719|            7|\n|          1806|           46|\n|         15237|            3|\n|         12568|            5|\n|          1677|           49|\n|         13452|            4|\n+--------------+-------------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1535315399506_1367589742","id":"20180822-165639_1364212336","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6586"},{"text":"\n%pyspark\n","dateUpdated":"2018-08-26T20:29:59+0000","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535315399507_1367204993","id":"20180825-013302_1279943201","dateCreated":"2018-08-26T20:29:59+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6587"}],"name":"assign","id":"2DNARMJDR","angularObjects":{"2DN4P9MY9:shared_process":[],"2DNTC3CVW:shared_process":[],"2DQ67DCE6:shared_process":[],"2DP9F9M9D:shared_process":[],"2DNX895ZC:shared_process":[],"2DMWUPKBQ:shared_process":[],"2DQ3K9D4N:shared_process":[],"2DRHRA9A8:shared_process":[],"2DNTSWDQH:shared_process":[],"2DP78DR23:shared_process":[],"2DNNW94J2:shared_process":[],"2DPY7E66N:shared_process":[],"2DPGX1YGN:shared_process":[],"2DRAVBFAF:shared_process":[],"2DPD3VU2U:shared_process":[],"2DNUGGJG9:shared_process":[],"2DRAM5DC6:shared_process":[],"2DP1JCZ83:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}